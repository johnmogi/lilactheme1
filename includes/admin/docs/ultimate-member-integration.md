# אינטגרציה עם Ultimate Member

## סקירה כללית

מסמך זה מתאר את האינטגרציה בין מערכת קודי ההרשמה לבין פלאגין Ultimate Member. האינטגרציה מאפשרת:

1. **תהליך הרשמה דו-שלבי** - אימות קוד הרשמה לפני הצגת טופס רישום לתלמידי חינוך תעבורתי
2. **שיוך חברויות אוטומטי** - הקצאת רמות חברות (באמצעות Paid Memberships Pro) בהתאם לסוג המשתמש
3. **תצוגה מותאמת לפי סוג משתמש** - טפסי רישום שונים לסוגי משתמשים שונים

## מבנה הקבצים

```
/includes/integrations/
  ├── class-ultimate-member-integration.php  # מחלקה ראשית לאינטגרציה עם UM
  ├── css/
  │   └── um-integration.css                 # סגנונות CSS לטופס אימות הקוד
  └── js/
      └── um-integration.js                  # סקריפטים לתהליך האימות והרישום
```

## שימוש בשורטקודים

### טופס הרשמה לתלמידי חינוך תעבורתי (עם אימות קוד)

השורטקוד `[verify_student_code]` מציג את שלב אימות הקוד, ולאחריו יש להציב את שורטקוד UM לרישום:

```
[verify_student_code]
[ultimatemember form_id="1128"]
```

הסקריפט יסתיר את טופס UM עד לאימות מוצלח של הקוד.

### טופס הרשמה לתלמידים עצמאיים (ללא צורך בקוד)

השורטקוד `[student_independent_registration]` מציג ישירות את טופס הרישום:

```
[student_independent_registration]
```

זהו שורטקוד-עוטף המכיל בתוכו `[ultimatemember form_id="1124"]`.

## מיפוי משתמשים ותפקידים

| סוג משתמש | שורטקוד | טופס רישום | רמת חברות | דורש קוד |
|-----------|---------|------------|-----------|-----------|
| תלמיד חינוך תעבורתי | `[verify_student_code]` + `[ultimatemember form_id="1128"]` | 1128 | 3 - תלמיד כיתה י' | כן |
| תלמיד עצמאי | `[student_independent_registration]` | 1124 | 2 - תלמיד עצמאי | לא |
| מורה / רכז | בפיתוח | בפיתוח | 4 - מורה | כן |

## תהליך עבודה - תלמיד חינוך תעבורתי

1. **שלב 1: אימות קוד**
   - המשתמש מזין קוד הרשמה בטופס אימות הקוד
   - המערכת מאמתת את הקוד מול בסיס הנתונים
   - אם הקוד תקף, המערכת מציגה למשתמש את טופס הרישום המלא

2. **שלב 2: הרשמה**
   - המשתמש ממלא את טופס הרישום של Ultimate Member
   - המערכת מאחזרת את פרטי הקוד משמירה זמנית (session)
   - המערכת מוודאת שהקוד עדיין תקף בעת שליחת הטופס

3. **שלב 3: השלמת הרישום**
   - המשתמש נרשם למערכת
   - הקוד מסומן כ"בשימוש" ומשויך למשתמש
   - המשתמש מוקצה אוטומטית לרמת חברות "תלמיד כיתה י'" (מספר 3)

## תהליך עבודה - תלמיד עצמאי

1. **שלב 1: הרשמה ישירה**
   - המשתמש ממלא ישירות את טופס הרישום של Ultimate Member
   - אין צורך באימות קוד

2. **שלב 2: השלמת הרישום**
   - המשתמש נרשם למערכת
   - המשתמש מוקצה אוטומטית לרמת חברות "תלמיד עצמאי" (מספר 2)

## תלויות וממשקים

האינטגרציה תלויה בפלאגינים הבאים:

1. **Ultimate Member** - לטפסי הרישום והתחברות
2. **Paid Memberships Pro** - לניהול רמות החברות

## התאמה ושינויים

### התאמת מראה טופס אימות הקוד

ניתן לעדכן את העיצוב באמצעות עריכת הקובץ:
`/includes/integrations/css/um-integration.css`

### שינוי מיפוי טפסים ורמות חברות

ניתן לשנות את המיפוי בין סוגי משתמשים לטפסים ולרמות חברות על ידי עדכון המערך `$user_type_mappings` בקובץ:
`/includes/integrations/class-ultimate-member-integration.php`

## פיתוחים עתידיים

1. **טופס הרשמה למורים** - יצירת תהליך הרשמה למורים עם אישור מנהל
2. **התאמה אוטומטית של שדות טופס** - התאמת שדות הטופס לפי הקבוצה אליה שייך הקוד
3. **שליחת מיילים אוטומטית** - שליחת מייל אישור לאחר הרשמה מוצלחת

## פתרון בעיות נפוצות

### הקוד אינו נשמר בין שלבי התהליך
- וודא שהשרת תומך בsession
- וודא שאין התנגשות עם plugins אחרים המשתמשים בsession

### טופס הרישום לא מוצג לאחר אימות קוד
- וודא שהjs הנדרש נטען בדף
- וודא שמזהה הטופס במיפוי תואם למזהה הטופס בUM

### משתמש לא מוקצה לרמת החברות הנכונה
- וודא שהפלאגין Paid Memberships Pro פעיל
- וודא שמספרי רמות החברות במיפוי תואמים לאלו שהוגדרו בPMPro

*עודכן לאחרונה: 22 באפריל 2025*
